<template>
  <svg
    width="20.799999mm"
    height="12.7mm"
    viewBox="0 0 169.10306 97.496161"
    version="1.1"
    id="svg5612"
    xmlns="http://www.w3.org/2000/svg"
    xmlns:svg="http://www.w3.org/2000/svg"
  >
    <defs id="defs5609" />
    <g
      id="layer1"
      transform="matrix(0.42215447,0,0,0.42796612,-40.6328,-2.7032164)"
    >
      <path
        @click="toggle"
        id="compresor_general"
        style="
          display: inline;
          fill: #ffffff;
          fill-opacity: 1;
          stroke-width: 0.0376569;
        "
        d="m 439.57256,214.11125 c -2.86302,1.09085 -7.10837,2.13624 -10.69991,2.6295 l -2.942,0.36782 -0.0826,8.27017 c -0.0963,9.02538 -0.055,9.22299 2.48481,10.23049 1.72105,0.70345 9.49768,0.77338 11.2332,0.0979 2.51589,-0.96218 2.60725,-1.42132 2.72281,-12.44868 0.0551,-5.51354 -0.0275,-10.01119 -0.19674,-10.01272 -0.21601,0.0279 -1.30019,0.41535 -2.51521,0.86428 z m -196.02184,7.35302 c -0.055,5.71045 0.0688,10.37229 0.31783,10.83422 0.21188,0.46152 1.02501,1.15799 1.79879,1.52566 1.24653,0.60137 2.02333,0.67409 6.51744,0.64892 l 5.14255,-0.056 1.26441,-1.07267 1.26441,-1.0391 0.0826,-8.36905 0.0826,-8.33619 -1.59627,-0.21117 c -3.32242,-0.45591 -9.26929,-1.92031 -11.76524,-2.89438 -1.42016,-0.53704 -2.66792,-1.00834 -2.7978,-1.00973 -0.12383,0 -0.2628,4.49456 -0.32058,9.97525 z m 175.1198,-53.55535 -0.49255,46.86622 4.71149,-0.18742 c 11.15187,-0.39437 20.8631,-3.52399 28.61344,-9.19933 5.39901,-3.92357 9.33892,-8.81183 11.73236,-14.50158 l 1.23965,-2.8776 0.20638,-19.69178 0.20776,-19.69164 -1.17912,-2.96417 c -5.55544,-14.09754 -20.79555,-23.48878 -39.45122,-24.37642 l -5.09618,-0.24194 z m -134.36165,-1.19295 -0.49118,46.7679 59.18792,0.52585 59.18846,0.52445 0.49118,-46.76804 0.49118,-46.76749 -59.18833,-0.52585 -59.18791,-0.52444 z m -25.43452,-46.63658 c -5.84039,0.70346 -11.38826,2.32728 -16.68627,4.87386 -8.9025,4.31906 -15.01626,10.46837 -18.42853,18.57827 l -1.24102,2.94292 -0.20776,19.69149 -0.20638,19.69178 1.17911,2.899 c 5.64129,14.09824 20.75249,23.38962 39.83963,24.41236 l 4.70695,0.27132 0.49119,-46.80078 0.49255,-46.83335 h -3.75926 c -2.11717,0.014 -4.88361,0.12588 -6.18145,0.27271 z m 146.83518,47.71358 -0.51182,48.73703 4.75207,0.042 4.75277,0.042 0.51182,-48.73701 0.51181,-48.73661 -4.75248,-0.042 -4.75236,-0.042 z m -133.92909,-1.28804 -0.51319,48.83605 4.75249,0.042 4.75222,0.042 0.51182,-48.70402 0.51182,-48.73689 -4.75126,-0.14124 -4.75153,-0.14125 z m 114.31485,-52.32269 -14.81978,-0.0279 -0.0138,1.96898 -0.0137,1.9694 14.90495,0.12588 14.90522,0.12589 0.0137,-2.13345 c 0.0137,-1.18176 -0.0137,-2.10087 -0.0688,-2.06857 -0.0826,0.0699 -6.78394,0.0699 -14.90646,0.0279 z m -100.79483,-0.73003 -0.0412,3.87266 5.18423,0.042 5.18438,0.042 0.0412,-3.87266 0.0412,-3.87251 -2.03269,0.179 c -1.16811,0.0839 -3.50046,0.0699 -5.2273,-0.042 l -3.10903,-0.19159 z m 66.90894,-6.43013 c -1.17635,0.97477 -0.98097,2.84682 0.35085,3.64622 1.11583,0.69926 1.41796,0.70207 33.64786,0.98736 32.22948,0.2853 32.53175,0.2881 33.66271,-0.39018 0.86955,-0.51745 1.1337,-0.94121 1.14334,-1.89347 0.0275,-2.4944 2.44407,-2.30882 -34.84018,-2.63957 -31.66827,-0.28111 -33.31021,-0.26292 -33.96416,0.28949 z m 18.49994,-17.133599 -15.683,8.13228 -0.0275,2.888089 -0.0275,2.9211 31.32237,0.2783 31.32252,0.27831 0.1101,-11.158969 0.11011,-11.15868 -15.72607,-0.13985 -15.68244,-0.13985 z m -86.14208,-21.80341 c -4.71919,0.90903 -8.10491,2.35707 -11.80665,5.14698 -3.78801,2.78895 -5.71573,5.29916 -7.00753,8.99699 -4.36559,12.49931 7.60313,24.815679 24.36453,25.095819 7.64675,0.0978 13.32381,-1.55628 18.68085,-5.54558 5.39956,-4.022429 7.82107,-8.300649 7.88284,-14.175149 0.055,-5.57927 -2.31515,-9.99861 -7.58593,-14.08271 -6.6004,-5.11301 -15.65287,-7.12996 -24.52811,-5.43635 z m 11.06163,4.06971 c 7.11525,1.31041 13.37306,6.12525 15.25826,11.75459 1.80018,5.46445 -0.59436,11.25295 -6.25203,15.1744 -8.40031,5.866379 -20.45255,5.595079 -28.46638,-0.67968 -11.14307,-8.63239 -5.84905,-23.12571 9.56525,-26.23855 2.38147,-0.47131 7.35025,-0.49227 9.8949,-0.014 z"
      />
      <path
        @click="toggle"
        d="m 451.23267,3.5717905 c -1.91226,0.56641 -7.19909,6.08889 -11.9235,11.8945805 l -8.66141,10.90336 22.94712,28.603633 22.94711,28.745237 8.66142,-11.186567 c 14.73564,-19.11629 14.2857,-23.08115 -4.61193,-47.578323 C 467.88058,8.5278605 460.79397,1.8725605 456.18205,2.1557705 c -0.89989,0 -3.1496,0.70801 -4.94938,1.41602 z"
        id="path4"
        style="fill: #ef8484; fill-opacity: 1; stroke-width: 0.126207"
      />
      <path
        @click="toggle"
        d="m 366.41833,107.22455 -53.09334,66.83622 v 29.02844 29.02843 l 23.28458,-0.4248 23.39706,-0.42481 53.09333,-66.83621 53.20582,-66.836209 -22.72215,-28.603627 c -12.59841,-15.85944 -23.0596,-28.745243 -23.39706,-28.745243 -0.33746,0 -24.52192,30.161263 -53.76824,66.977809 z m 56.91785,-36.533346 c 0.44994,3.96486 -57.03034,76.323556 -60.06746,75.473936 -5.73678,-1.27441 -3.03712,-5.66408 26.09672,-42.48064 29.35882,-36.816556 33.07085,-40.498206 33.97074,-32.993296 z M 359.10675,174.91038 c 6.07423,7.78812 11.1361,14.44342 11.36107,14.58502 0.11248,0.2832 -3.82452,5.66409 -8.7739,11.89458 -8.32395,10.76176 -9.33633,11.61137 -13.4983,11.61137 h -4.49944 v -9.91214 -9.91215 h -7.87401 -7.87401 v -5.23928 c 0,-4.81448 1.01237,-6.5137 9.22384,-16.99226 5.06186,-6.3721 9.5613,-11.32817 10.01124,-10.90337 0.44995,0.28321 5.84927,7.08011 11.92351,14.86823 z"
        id="path6"
        style="fill: #e39b39; fill-opacity: 1; stroke-width: 0.126207"
      />
      <ellipse
        v-if="toggleClick"
        style="
          fill: #1caf26;
          fill-opacity: 1;
          stroke: #ffff00;
          stroke-width: 0.00222156;
          stroke-dasharray: 1.16613, 0.29153;
        "
        id="check"
        cx="290.77155"
        cy="87.432739"
        rx="20.634279"
        ry="15.872113"
      />
    </g>
    <rect
      v-if="enviar"
      @click="clickEnviar"
      style="
        fill: #ffffff;
        fill-opacity: 1;
        stroke: #b2b2b2;
        stroke-width: 0.000432115;
        stroke-dasharray: 0.226821, 0.0567051;
        stroke-opacity: 1;
      "
      id="rect7138"
      width="32.422115"
      height="31.578997"
      x="4.9433751"
      y="2.9696777"
      ry="0.33188498"
    />
    <path
      v-if="enviar"
      @click="clickEnviar"
      id="enviar"
      style="
        fill: #008011;
        fill-opacity: 1;
        stroke: #ffffff;
        stroke-width: 0.00493275;
        stroke-opacity: 1;
      "
      d="M 21.253925,1.8638869 C 13.026069,1.8589653 7.419999,1.8737301 7.226344,1.9031314 6.4964137,2.0060358 5.7366618,2.3637256 5.1656266,2.8831395 4.8279718,3.1869484 4.3909803,3.8288591 4.2221527,4.2649694 3.9341539,5.0195935 3.9490981,4.2453685 3.9490981,18.749834 c 0,14.396647 -0.00991,13.735165 0.2582171,14.440787 0.1489653,0.396913 0.4667214,0.911457 0.7547202,1.225066 0.4717251,0.514514 1.2512895,0.965308 1.9613588,1.127011 0.3575168,0.0833 1.1024248,0.08822 14.1567628,0.08822 13.054338,0 13.799173,-0.0049 14.156691,-0.08822 0.665378,-0.151903 1.469772,-0.602714 1.886875,-1.048629 0.466758,-0.499813 0.829242,-1.151507 0.968277,-1.754224 0.08938,-0.377312 0.09434,-0.882103 0.09434,-13.990011 0,-15.288478 0.03476,-13.9115184 -0.372414,-14.7494418 -0.511449,-1.0339319 -1.370449,-1.7298177 -2.54231,-2.043427 -0.292965,-0.078399 -1.17687,-0.088195 -14.017691,-0.093095 z M 31.66167,9.8487326 c 0.287999,0.01468 0.575963,0.05882 0.754721,0.124971 1.092412,0.4214144 1.742961,1.6415494 1.454962,2.7391844 -0.193656,0.744824 0.307816,0.220535 -7.99949,8.413591 -6.668686,6.585804 -7.681676,7.565842 -7.929953,7.683443 -0.839171,0.396913 -1.737952,0.357702 -2.452988,-0.107813 C 15.305199,28.584503 13.994297,27.320274 11.913746,25.262211 8.914574,22.287817 8.621622,21.979056 8.482588,21.689948 8.398178,21.513545 8.303844,21.253868 8.27405,21.111761 7.921498,19.42611 9.445922,17.95112 11.159025,18.328432 c 0.670343,0.147002 0.769656,0.230328 3.297103,2.734306 1.276136,1.259337 2.328821,2.293291 2.348682,2.293291 0.0149,0 3.033924,-2.959699 6.708406,-6.580912 7.001374,-6.8994134 6.792833,-6.703413 7.393659,-6.8749174 0.17876,-0.05145 0.466794,-0.06617 0.754795,-0.05147 z"
    />
    <path
      v-if="cancelar"
      @click="clickCancelar"
      style="
        fill: #ffffff;
        fill-opacity: 1;
        stroke: #ffffff;
        stroke-width: 0.0232844;
        stroke-dasharray: 12.2222, 3.05557;
        stroke-opacity: 1;
      "
      id="circulo_cancelar"
      d="M 38.788038,79.772026 A 17.953993,15.93407 0 0 1 20.836127,95.706096 17.953993,15.93407 0 0 1 2.880053,79.775721 17.953993,15.93407 0 0 1 20.8278,63.837957 17.953993,15.93407 0 0 1 38.788036,79.764636 l -17.953991,0.0074 z"
    />
    <g
      v-if="cancelar"
      @click="clickCancelar"
      transform="matrix(0.00715205,0,0,-0.00672658,-2.2340583,100.58903)"
      fill="#000000"
      stroke="none"
      id="cancelar"
      style="fill: #d40000; fill-opacity: 1"
    >
      <path
        d="M 2885,5760 C 2264,5698 1699,5432 1265,4996 1054,4785 902,4573 771,4310 570,3906 479,3496 494,3055 506,2656 589,2324 765,1965 1026,1433 1433,1026 1965,764 2626,440 3357,403 4055,658 c 231,84 528,253 735,418 225,179 479,475 623,725 601,1044 431,2347 -417,3195 -415,414 -945,675 -1531,754 -110,15 -470,21 -580,10 z m 474,-450 c 414,-44 837,-219 1154,-478 389,-319 657,-757 762,-1247 63,-291 61,-641 -5,-937 -159,-712 -686,-1316 -1374,-1573 -124,-46 -287,-89 -425,-112 -150,-25 -532,-25 -682,0 -463,78 -856,277 -1187,601 -190,186 -311,350 -426,576 -160,314 -236,634 -236,990 0,745 362,1416 990,1833 254,169 595,298 890,336 47,6 96,13 110,15 56,8 341,5 429,-4 z"
        id="path9686"
        style="fill: #d40000; fill-opacity: 1"
      />
      <path
        d="m 3635,3950 c -280,-280 -514,-510 -520,-510 -5,0 -214,204 -462,453 l -453,453 -142,-143 -143,-143 453,-453 c 248,-248 452,-457 452,-462 0,-5 -231,-241 -512,-522 l -513,-513 158,-157 157,-158 513,513 c 281,281 517,512 522,512 5,0 214,-204 462,-452 l 453,-453 143,143 142,142 -452,453 c -249,248 -453,456 -453,462 0,5 231,241 512,522 l 513,513 -155,155 c -85,85 -157,155 -160,155 -3,0 -235,-229 -515,-510 z"
        id="path9688"
        style="fill: #d40000; fill-opacity: 1"
      />
    </g>
  </svg>
</template>

<script setup>
import { ref, watch } from "vue";
import { useHomeMantenimientoStore } from "@/stores/homeMantenimientoStore";
import { useDataHomeMantenimiento } from "../componsables/useMantenimiento";
import { useMantenimientoEdicion } from "@/stores/mantenimientoEdicion";
import { useReferenceStore } from "@/stores/referencesStore";
import { useSvgStore } from "@/stores/svgStore";

const serverApi = import.meta.env.VITE_SERVER_API;
const serverNodeRed = import.meta.env.VITE_SERVER_NODE_RED;
const referenceStore = useReferenceStore();
const mapa = useSvgStore();
let storeData = useHomeMantenimientoStore().datos;
let estados = ref({});

const edicion = useMantenimientoEdicion();
const toggleClick = ref(false);
const enviar = ref(false);
const cancelar = ref(false);

const toggle = async () => {
  //showMark.value = !showMark.value;
  toggleClick.value = !toggleClick.value;
  if (!storeData) {
    await useDataHomeMantenimiento();
    storeData = useHomeMantenimientoStore().datos;
  }
  estados.value = storeData.marchaCompresores;
  const compresores = estados.value;
  const map = mapa.svgRef;

  if (toggleClick.value) {
    for (let x in compresores) {
      const nombre = x;
      const pos = nombre.lastIndexOf("_");
      const compresorNombre = nombre.slice(0, pos);
      const compresor = map.querySelector(`#${compresorNombre}`);
      const elemento = map.querySelector(`#${nombre}`);

      const handler = () => {
          edicion.acciones.marchaCompresores = true;

          const estadoActual = edicion.edicion.marchaCompresores[nombre] || compresores[nombre];

          if (estadoActual === 'ACTIVO') {
              elemento.style.fill = '#e81b06'; // rojo
              edicion.edicion.marchaCompresores = {
                ...edicion.edicion.marchaCompresores,
                [nombre]: 'INACTIVO'
              };
          } else {
              elemento.style.fill = '#29B32E'; // verde
              edicion.edicion.marchaCompresores = {
                ...edicion.edicion.marchaCompresores,
                [nombre]: 'ACTIVO'
              };
          }
      };


      if (elemento) {
        elemento.addEventListener("click", handler);
        elemento.style.cursor = "pointer";
        if (!referenceStore.reference[`#${nombre}`]) {
          referenceStore.$patch((state) => {
            state.reference[`#${nombre}`] = {}; // crea el objeto vacío reactivamente
          });
        }
        referenceStore.reference[`#${nombre}`]["click"] = handler;
      }

      if (compresor) {
        compresor.addEventListener("click", handler);
        compresor.style.cursor = "pointer";
        if (!referenceStore.reference[`#${compresorNombre}`]) {
          referenceStore.$patch((state) => {
            state.reference[`#${compresorNombre}`] = {}; // crea el objeto vacío reactivamente
          });
        }
        referenceStore.reference[`#${compresorNombre}`]["click"] = handler;
      }
    }
  } else {
    for (let x in compresores) {
      const nombre = x;
      const pos = nombre.lastIndexOf("_");
      const compresorNombre = nombre.slice(0, pos);
      const compresor = map.querySelector(`#${compresorNombre}`);
      const elemento = map.querySelector(`#${nombre}`);

      if (elemento) {
        elemento.style.cursor = "default";
        const reference = referenceStore.reference[`#${nombre}`]["click"];
        elemento.removeEventListener("click", reference);
        referenceStore.reference[`#${nombre}`]["click"] = "";
      }

      if (compresor) {
        compresor.style.cursor = "default";
        const reference = referenceStore.reference[`#${compresorNombre}`]["click"];
        compresor.removeEventListener("click", reference);
        referenceStore.reference[`#${compresorNombre}`]["click"] = "";
      }
    }
  }
};

const clickEnviar = async () => {
  const res = await fetch(`${serverApi}/api/edicionMarchaCompresores`, {
    method: "POST",
    credentials: "include",
    headers: {
      "Content-Type": "application/json"
    },
    body: JSON.stringify(edicion.edicion.marchaCompresores)
  });

  const resJson = await res.json();
  //console.log(res.json);
  if(resJson.status = 'Ok'){
    console.log(resJson.message);
    await useDataHomeMantenimiento();
    storeData = useHomeMantenimientoStore().datos;
    //console.log(storeData.marchaCompresores);
    edicion.edicion.marchaCompresores = storeData.marchaCompresores;
    edicion.$patch((state) => {
      state.edicion.marchaCompresores = {
      
      };
      state.acciones.marchaCompresores = false;
    });
    edicion.acciones.marchaCompresores = false;
    enviar.value = false;
    cancelar.value = false;
    //toggleClick.value = false;
    toggle();
  }
};

const clickCancelar = async () => {
  await useDataHomeMantenimiento();
  storeData = useHomeMantenimientoStore().datos;
  //console.log(storeData.marchaCompresores);
  edicion.edicion.marchaCompresores = storeData.marchaCompresores;
  edicion.$patch((state) => {
    state.edicion.marchaCompresores = {
      
    };
    state.acciones.marchaCompresores = false;
  });
  edicion.acciones.marchaCompresores = false;
  enviar.value = false;
  cancelar.value = false;
  //toggleClick.value = false;
};

watch(
  () => edicion.acciones.marchaCompresores,
  (activo) => {
    if (activo) {
      enviar.value = true;
      cancelar.value = true;
    } else {
      enviar.value = false;
      cancelar.value = false;
    }
  }
);
</script>
