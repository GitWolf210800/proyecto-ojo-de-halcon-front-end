<template>
  <div class="content_clima_exterior">
    <svg
      ref="svgRef"
      width="62.6mm"
      height="13mm"
      viewBox="0 0 78.768006 16.432522"
      version="1.1"
      id="svg66787"
      xmlns="http://www.w3.org/2000/svg"
      xmlns:svg="http://www.w3.org/2000/svg"
    >
      <defs id="defs66784">
        <rect
          x="286.77979"
          y="152.90392"
          width="157.66093"
          height="77.471321"
          id="rect1315"
        />
        <rect
          x="286.77979"
          y="152.90392"
          width="202.14038"
          height="77.333549"
          id="rect1315-7"
        />
        <rect
          x="286.77979"
          y="152.90392"
          width="157.66093"
          height="77.471321"
          id="rect1315-2"
        />
      </defs>
      <g id="layer1" transform="matrix(0.83972719,0,0,1,-53.984085,-26.057004)">
        <text
          xml:space="preserve"
          style="
            font-style: normal;
            font-variant: normal;
            font-weight: normal;
            font-stretch: normal;
            font-size: 3.28872px;
            font-family: Dubai;
            -inkscape-font-specification: 'Dubai, Normal';
            font-variant-ligatures: normal;
            font-variant-caps: normal;
            font-variant-numeric: normal;
            font-variant-east-asian: normal;
            display: inline;
            fill: #fefefb;
            stroke: #fdfdfd;
            stroke-width: 0;
            stroke-dasharray: none;
          "
          x="57.335812"
          y="47.122555"
          id="tempExterior"
          transform="scale(1.1272473,0.88711677)"
        >
          <tspan
            id="tspan1550"
            x="57.335812"
            y="47.122555"
            style="
              font-style: normal;
              font-variant: normal;
              font-weight: normal;
              font-stretch: normal;
              font-size: 3.28872px;
              font-family: Dubai;
              -inkscape-font-specification: 'Dubai, Normal';
              font-variant-ligatures: normal;
              font-variant-caps: normal;
              font-variant-numeric: normal;
              font-variant-east-asian: normal;
              stroke-width: 0;
            "
          >
            Temperatura
          </tspan>
        </text>
        <text
          xml:space="preserve"
          style="
            font-style: normal;
            font-variant: normal;
            font-weight: normal;
            font-stretch: normal;
            font-size: 3.38678px;
            font-family: Dubai;
            -inkscape-font-specification: 'Dubai, Normal';
            font-variant-ligatures: normal;
            font-variant-caps: normal;
            font-variant-numeric: normal;
            font-variant-east-asian: normal;
            display: inline;
            fill: #fefefb;
            stroke: #fdfdfd;
            stroke-width: 0;
            stroke-dasharray: none;
          "
          x="107.73171"
          y="52.239475"
          id="entalpiaExterior"
          transform="scale(1.2442929,0.80366929)"
        >
          <tspan
            id="tspan1554"
            x="107.73171"
            y="52.239475"
            style="
              font-style: normal;
              font-variant: normal;
              font-weight: normal;
              font-stretch: normal;
              font-size: 3.38678px;
              font-family: Dubai;
              -inkscape-font-specification: 'Dubai, Normal';
              font-variant-ligatures: normal;
              font-variant-caps: normal;
              font-variant-numeric: normal;
              font-variant-east-asian: normal;
              stroke-width: 0;
            "
          >
            Entalpía
          </tspan>
        </text>
        <text
          xml:space="preserve"
          style="
            font-style: normal;
            font-variant: normal;
            font-weight: normal;
            font-stretch: normal;
            font-size: 3.58998px;
            font-family: Dubai;
            -inkscape-font-specification: 'Dubai, Normal';
            font-variant-ligatures: normal;
            font-variant-caps: normal;
            font-variant-numeric: normal;
            font-variant-east-asian: normal;
            display: inline;
            fill: #fefefb;
            stroke: #fdfdfd;
            stroke-width: 0;
            stroke-dasharray: none;
          "
          x="81.715401"
          y="50.922672"
          id="tempExterior-0"
          transform="scale(1.2102917,0.82624709)"
        >
          <tspan
            id="tspan1552"
            x="81.715401"
            y="50.922672"
            style="
              font-style: normal;
              font-variant: normal;
              font-weight: normal;
              font-stretch: normal;
              font-size: 3.58998px;
              font-family: Dubai;
              -inkscape-font-specification: 'Dubai, Normal';
              font-variant-ligatures: normal;
              font-variant-caps: normal;
              font-variant-numeric: normal;
              font-variant-east-asian: normal;
              stroke-width: 0;
            "
          >
            Humedad
          </tspan>
        </text>
        <text
          xml:space="preserve"
          style="
            font-style: normal;
            font-variant: normal;
            font-weight: normal;
            font-stretch: normal;
            font-size: 3.71249px;
            font-family: Dubai;
            -inkscape-font-specification: 'Dubai, Normal';
            font-variant-ligatures: normal;
            font-variant-caps: normal;
            font-variant-numeric: normal;
            font-variant-east-asian: normal;
            display: inline;
            fill: #6adacd;
            fill-opacity: 1;
            stroke: #fdfdfd;
            stroke-width: 0;
            stroke-dasharray: none;
          "
          x="76.094185"
          y="40.214405"
          id="tempExterior-0-3"
          transform="scale(1.2515931,0.7989817)"
        >
          <tspan
            id="tspan1552-7"
            x="76.094185"
            y="40.214405"
            style="
              font-style: normal;
              font-variant: normal;
              font-weight: normal;
              font-stretch: normal;
              font-size: 3.71249px;
              font-family: Dubai;
              -inkscape-font-specification: 'Dubai, Normal';
              font-variant-ligatures: normal;
              font-variant-caps: normal;
              font-variant-numeric: normal;
              font-variant-east-asian: normal;
              fill: #6adacd;
              fill-opacity: 1;
              stroke-width: 0;
            "
          >
            Clima Exterior
          </tspan>
        </text>
        <text
          xml:space="preserve"
          transform="matrix(0.21496937,0,0,0.18186166,2.3552073,4.4634021)"
          style="
            font-style: normal;
            font-variant: normal;
            font-weight: normal;
            font-stretch: normal;
            font-size: 37.3333px;
            font-family: sans-serif;
            -inkscape-font-specification: 'sans-serif, Normal';
            font-variant-ligatures: normal;
            font-variant-caps: normal;
            font-variant-numeric: normal;
            font-variant-east-asian: normal;
            white-space: pre;
            shape-inside: url(#rect1315);
            display: inline;
            fill: #c96100;
            fill-opacity: 1;
            stroke: #c96100;
            stroke-width: 0.71811;
            stroke-dasharray: none;
            stroke-opacity: 1;
          "
          id="fab9_exterior_clima_temp_g"
        >
          <tspan x="286.7793" y="186.87294" id="fab9_exterior_clima_temp_text">
            -- °C
          </tspan>
        </text>
        <text
          xml:space="preserve"
          transform="matrix(0.19149612,0,0,0.18888555,73.534655,2.8780624)"
          style="
            font-style: normal;
            font-variant: normal;
            font-weight: normal;
            font-stretch: normal;
            font-size: 37.3333px;
            font-family: sans-serif;
            -inkscape-font-specification: 'sans-serif, Normal';
            font-variant-ligatures: normal;
            font-variant-caps: normal;
            font-variant-numeric: normal;
            font-variant-east-asian: normal;
            white-space: pre;
            shape-inside: url(#rect1315-7);
            display: inline;
            fill: #00be0d;
            fill-opacity: 1;
            stroke: #09d025;
            stroke-width: 0.71811;
            stroke-dasharray: none;
            stroke-opacity: 1;
          "
          id="fab9_exterior_clima_entalpia_g"
        >
          <tspan
            x="286.7793"
            y="186.87294"
            id="fab9_exterior_clima_entalpia_text"
          >
            -- Kj/Kg
          </tspan>
        </text>
        <text
          xml:space="preserve"
          transform="matrix(0.23950605,0,0,0.18160369,20.931316,4.5928984)"
          style="
            font-style: normal;
            font-variant: normal;
            font-weight: normal;
            font-stretch: normal;
            font-size: 37.3333px;
            font-family: sans-serif;
            -inkscape-font-specification: 'sans-serif, Normal';
            font-variant-ligatures: normal;
            font-variant-caps: normal;
            font-variant-numeric: normal;
            font-variant-east-asian: normal;
            white-space: pre;
            shape-inside: url(#rect1315-2);
            display: inline;
            fill: #0098ff;
            fill-opacity: 1;
            stroke: #49cdf7;
            stroke-width: 0.71811;
            stroke-dasharray: none;
            stroke-opacity: 1;
          "
          id="fab9_exterior_clima_hum_g"
        >
          <tspan x="286.7793" y="186.87294" id="fab9_exterior_clima_hum_text">
            -- % H.r
          </tspan>
        </text>
        <text
          xml:space="preserve"
          style="
            font-style: normal;
            font-variant: normal;
            font-weight: normal;
            font-stretch: normal;
            font-size: 3.59633px;
            font-family: sans-serif;
            -inkscape-font-specification: 'sans-serif, Normal';
            font-variant-ligatures: normal;
            font-variant-caps: normal;
            font-variant-numeric: normal;
            font-variant-east-asian: normal;
            display: inline;
            fill: #d5d5d5;
            fill-opacity: 1;
            stroke: #09d025;
            stroke-width: 0;
          "
          x="66.352539"
          y="28.279486"
          transform="scale(0.97957141,1.0208546)"
          id="text494"
        >
          <tspan
            id="ultimaVez"
            x="66.352539"
            y="28.279486"
            style="stroke-width: 0"
          >
            última actualización: nn/nn/nn nn:nn Hs
          </tspan>
        </text>
      </g>
    </svg>
  </div>
  <ToolTipChart
    :position="tooltipPosition"
    :parametros="params"
    v-if="tooltip.visibility.chart && tooltip.activeTooltipId === currentTooltipId"
  />
</template>

<script setup>
import { onMounted, ref, onUnmounted, computed } from "vue";
import axios from "axios";
import {
  //server,
  tempHotExt,
  tempMhotExt,
  tempOkExt,
  tempoColdExt,
  elementsConfigTyH,
  TOOLTIP_CHART_CONFIG,
} from "@/variables";
import { useTooltip } from "@/modules/tooltip/utils/useTooltip";
import ToolTipChart from "@/modules/tooltip/components/ToolTipChart.vue";
import { createTooltipConfig } from "@/funciones";
import { useTooltipStore } from "@/stores/tooltipStore";
let intervalId;
const svgRef = ref(null);
const serverNodeRed = import.meta.env.VITE_SERVER_NODE_RED;

const {
  tooltipPosition,
  params,
  tooltipVisibility,
  displayTooltip,
  hideTooltip,
} = useTooltip();

const tooltip = useTooltipStore();
const currentTooltipId = computed(() =>
  params.value && params.value.nombre && params.value.medicion
    ? `${params.value.nombre}_${params.value.medicion}`
    : null
);

/*function createTooltipConfig(selector, tooltipType, payload, config) {
  return { selector, tooltipType, payload, config };
}*/

async function dataAndAccion() {
  try {
    console.log(`${serverNodeRed}/climaExterior`);
    const response = await axios.get(`${serverNodeRed}/climaExterior`);
    if (response.data) {
      //console.log(response.data);
      const svg = svgRef.value;
      const datosClima = response.data.clima[0];
      const nombre = datosClima.nombre;
      const ultimaVez = svg.querySelector("#ultimaVez");
      ultimaVez.textContent = response.data.ultimaVez;
      const colorTemp = svg.querySelector(`#${nombre}_temp_g`);

      const textTemp = svg.querySelector(`#${datosClima.nombre}_temp_text`);
      const textHum = svg.querySelector(`#${datosClima.nombre}_hum_text`);
      const textEntalpia = svg.querySelector(
        `#${datosClima.nombre}_entalpia_text`
      );

      const temperatura = datosClima.temperatura
        ? Math.abs(datosClima.temperatura.toFixed(0))
        : "NaN";
      const humedad = datosClima.humedad
        ? Math.abs(datosClima.humedad.toFixed(0))
        : "NaN";
      const entalpia = datosClima.entalpia
        ? Math.abs(datosClima.entalpia.toFixed(0))
        : "NaN";

      if (textTemp) {
        textTemp.textContent = `${temperatura}°C`;
      }

      if (textHum) {
        textHum.textContent = `${humedad}% H.r`;
      }

      if (textEntalpia) {
        textEntalpia.textContent = `${entalpia} Kj/kg`;
      }

      if (temperatura > 38) {
        colorTemp.style.fill = tempHotExt;
        colorTemp.style.stroke = tempHotExt;
      } else if (temperatura < 39 && temperatura >= 30) {
        colorTemp.style.fill = tempMhotExt;
        colorTemp.style.stroke = tempMhotExt;
      } else if (temperatura < 30 && temperatura > 20) {
        colorTemp.style.fill = tempOkExt;
        colorTemp.style.stroke = tempOkExt;
      } else {
        colorTemp.style.fill = tempoColdExt;
        colorTemp.style.stroke = tempoColdExt;
      }

      const tooltipConfigs = [
        ...elementsConfigTyH.map(({ idSuffix, metric }) =>
          createTooltipConfig(
            `#${nombre}_${idSuffix}`,
            "chart",
            { nombre, medicion: metric, tabla: "mediciones_clima_24hs" },
            TOOLTIP_CHART_CONFIG
          )
        ),
      ];

      tooltipConfigs.forEach(({ selector, tooltipType, payload, config }) => {
        const element = svg.querySelector(selector);
        if (element) {
          //console.log(element);
          element.addEventListener("mouseover", (e) =>
            displayTooltip(e, tooltipType, payload, config)
          );
          element.addEventListener("mouseleave", () =>
            hideTooltip(tooltipType)
          );
        }
      });
    } else {
      console.warn("error en clima exterior");
    }
  } catch {
    console.warn("No hay conexion con el servidor");
  }
}

onMounted(() => {
  dataAndAccion();
  intervalId = setInterval(dataAndAccion, 10000); // Llama a fetchData cada 10 segundos
});

// Limpia el intervalo cuando el componente se desmonte
onUnmounted(() => {
  clearInterval(intervalId);
});
</script>

<style scoped></style>
