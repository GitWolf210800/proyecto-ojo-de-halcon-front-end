<template>
  <div class="content_clima_exterior">
    <svg
      ref="svgRef"
      width="118.77859mm"
      height="21.563564mm"
      viewBox="0 0 118.7786 21.563564"
      version="1.1"
      id="svg66787"
      xmlns="http://www.w3.org/2000/svg"
      xmlns:svg="http://www.w3.org/2000/svg"
    >
      <defs id="defs66784">
        <rect
          x="286.77979"
          y="152.90392"
          width="157.66093"
          height="77.471321"
          id="rect1315"
        />
        <rect
          x="286.77979"
          y="152.90392"
          width="202.14038"
          height="77.333549"
          id="rect1315-7"
        />
        <rect
          x="286.77979"
          y="152.90392"
          width="157.66093"
          height="77.471321"
          id="rect1315-2"
        />
      </defs>
      <g id="layer1" transform="translate(-30.838343,-25.901549)">
        <text
          xml:space="preserve"
          style="
            font-style: normal;
            font-variant: normal;
            font-weight: 500;
            font-stretch: normal;
            font-size: 4.95171px;
            font-family: Dubai;
            -inkscape-font-specification: 'Dubai, Medium';
            font-variant-ligatures: normal;
            font-variant-caps: normal;
            font-variant-numeric: normal;
            font-variant-east-asian: normal;
            display: inline;
            fill: #fefefb;
            stroke: #fdfdfd;
            stroke-width: 0;
            stroke-dasharray: none;
          "
          x="42.016109"
          y="33.494465"
          id="tempExterior"
          transform="scale(0.73258336,1.3650324)"
        >
          <tspan
            id="tspan1550"
            x="42.016109"
            y="33.494465"
            style="stroke-width: 0"
          >
            Temperatura Exterior
          </tspan>
        </text>
        <text
          xml:space="preserve"
          style="
            font-style: normal;
            font-variant: normal;
            font-weight: 500;
            font-stretch: normal;
            font-size: 5.14038px;
            font-family: Dubai;
            -inkscape-font-specification: 'Dubai, Medium';
            font-variant-ligatures: normal;
            font-variant-caps: normal;
            font-variant-numeric: normal;
            font-variant-east-asian: normal;
            display: inline;
            fill: #fefefb;
            stroke: #fdfdfd;
            stroke-width: 0;
            stroke-dasharray: none;
          "
          x="156.59445"
          y="35.215694"
          id="entalpiaExterior"
          transform="scale(0.76207139,1.312213)"
        >
          <tspan
            id="tspan1554"
            x="156.59445"
            y="35.215694"
            style="stroke-width: 0"
          >
            Entalpía Exterior
          </tspan>
        </text>
        <text
          xml:space="preserve"
          style="
            font-style: normal;
            font-variant: normal;
            font-weight: 500;
            font-stretch: normal;
            font-size: 5.14038px;
            font-family: Dubai;
            -inkscape-font-specification: 'Dubai, Medium';
            font-variant-ligatures: normal;
            font-variant-caps: normal;
            font-variant-numeric: normal;
            font-variant-east-asian: normal;
            display: inline;
            fill: #fefefb;
            stroke: #fdfdfd;
            stroke-width: 0;
            stroke-dasharray: none;
          "
          x="96.949959"
          y="35.056263"
          id="tempExterior-0"
          transform="scale(0.76207139,1.312213)"
        >
          <tspan
            id="tspan1552"
            x="96.949959"
            y="35.056263"
            style="stroke-width: 0"
          >
            Humedad Exterior
          </tspan>
        </text>
        <text
          xml:space="preserve"
          transform="matrix(0.15973356,0,0,0.27504559,-6.8581711,-11.767043)"
          style="
            font-style: normal;
            font-variant: normal;
            font-weight: normal;
            font-stretch: normal;
            font-size: 37.3333px;
            font-family: sans-serif;
            -inkscape-font-specification: 'sans-serif, Normal';
            font-variant-ligatures: normal;
            font-variant-caps: normal;
            font-variant-numeric: normal;
            font-variant-east-asian: normal;
            white-space: pre;
            shape-inside: url(#rect1315);
            display: inline;
            fill: #ffff00;
            fill-opacity: 1;
            stroke: #e2e80a;
            stroke-width: 0.71811;
            stroke-dasharray: none;
            stroke-opacity: 1;
          "
          id="fab9_exterior_clima_temp_g"
        >
          <tspan x="286.7793" y="186.87294" id="fab9_exterior_clima_temp_text">
            32 °C
          </tspan>
        </text>
        <text
          xml:space="preserve"
          transform="matrix(0.14458807,0,0,0.25056296,79.938821,-7.803241)"
          style="
            font-style: normal;
            font-variant: normal;
            font-weight: normal;
            font-stretch: normal;
            font-size: 37.3333px;
            font-family: sans-serif;
            -inkscape-font-specification: 'sans-serif, Normal';
            font-variant-ligatures: normal;
            font-variant-caps: normal;
            font-variant-numeric: normal;
            font-variant-east-asian: normal;
            white-space: pre;
            shape-inside: url(#rect1315-7);
            display: inline;
            fill: #00be0d;
            fill-opacity: 1;
            stroke: #09d025;
            stroke-width: 0.71811;
            stroke-dasharray: none;
            stroke-opacity: 1;
          "
          id="fab9_exterior_clima_entalpia_g"
        >
          <tspan
            x="286.7793"
            y="186.87294"
            id="fab9_exterior_clima_entalpia_text"
          >
            66.66 Kj/Kg
          </tspan>
        </text>
        <text
          xml:space="preserve"
          transform="matrix(0.15973356,0,0,0.27504559,36.387691,-11.384347)"
          style="
            font-style: normal;
            font-variant: normal;
            font-weight: normal;
            font-stretch: normal;
            font-size: 37.3333px;
            font-family: sans-serif;
            -inkscape-font-specification: 'sans-serif, Normal';
            font-variant-ligatures: normal;
            font-variant-caps: normal;
            font-variant-numeric: normal;
            font-variant-east-asian: normal;
            white-space: pre;
            shape-inside: url(#rect1315-2);
            display: inline;
            fill: #0098ff;
            fill-opacity: 1;
            stroke: #49cdf7;
            stroke-width: 0.71811;
            stroke-dasharray: none;
            stroke-opacity: 1;
          "
          id="fab9_exterior_clima_hum_g"
        >
          <tspan x="286.7793" y="186.87294" id="fab9_exterior_clima_hum_text">
            50 %
          </tspan>
        </text>
        <text
          xml:space="preserve"
          style="
            font-style: normal;
            font-variant: normal;
            font-weight: normal;
            font-stretch: normal;
            font-size: 5.26919px;
            font-family: sans-serif;
            -inkscape-font-specification: 'sans-serif, Normal';
            font-variant-ligatures: normal;
            font-variant-caps: normal;
            font-variant-numeric: normal;
            font-variant-east-asian: normal;
            display: inline;
            fill: #d5d5d5;
            fill-opacity: 1;
            stroke: #09d025;
            stroke-width: 0;
          "
          x="43.009022"
          y="28.79361"
          transform="scale(0.95582736,1.046214)"
          id="text494"
        >
          <tspan
            id="ultimaVez"
            x="43.009022"
            y="28.79361"
            style="stroke-width: 0"
          >
            última actualización: 21/11/2023 11:29 Hs
          </tspan>
        </text>
      </g>
    </svg>
  </div>
  <ToolTipChart
      :position="tooltipPosition"
      :parametros="params"
      v-if="tooltipVisibility.chart"
    />
</template>

<script setup>
import { onMounted, ref, onUnmounted } from 'vue';
import axios from 'axios';
import { server, 
        tempHotExt,
        tempMhotExt,
        tempOkExt,
        tempoColdExt,
        elementsConfigTyH, 
        TOOLTIP_CHART_CONFIG 
    } from '@/variables';
import { useTooltip } from '@/modules/tooltip/utils/useTooltip';
import ToolTipChart from '@/modules/tooltip/components/ToolTipChart.vue';
import { createTooltipConfig } from '@/funciones';
let intervalId;
const svgRef = ref(null);

const { tooltipPosition, params, tooltipVisibility, displayTooltip, hideTooltip } = useTooltip();

/*function createTooltipConfig(selector, tooltipType, payload, config) {
  return { selector, tooltipType, payload, config };
}*/

async function dataAndAccion() {
    try{
        const response = await axios.get(`${server}:1880/climaExterior`);
        if (response.data){
            //console.log(response.data);
            const svg = svgRef.value;
            const datosClima = response.data.clima[0];
            const nombre = datosClima.nombre;
            const ultimaVez = svg.querySelector('#ultimaVez');
            ultimaVez.textContent = response.data.ultimaVez;
            const colorTemp = svg.querySelector(`#${nombre}_temp_g`);

            const textTemp = svg.querySelector(`#${datosClima.nombre}_temp_text`);
            const textHum = svg.querySelector(`#${datosClima.nombre}_hum_text`);
            const textEntalpia = svg.querySelector(`#${datosClima.nombre}_entalpia_text`);

            const temperatura = datosClima.temperatura ? Math.abs(datosClima.temperatura.toFixed(0)) : 'NaN';
            const humedad = datosClima.humedad ? Math.abs(datosClima.humedad.toFixed(0)) : 'NaN';
            const entalpia = datosClima.entalpia ? Math.abs(datosClima.entalpia.toFixed(0)) : 'NaN';
            

            if(textTemp){
                textTemp.textContent = `${temperatura}°C`;
            }
      
            if(textHum){
                textHum.textContent = `${humedad}% H.r`;
            }

            if(textEntalpia){
              textEntalpia.textContent = `${entalpia} Kj/kg`;
            }

            if ( temperatura > 38 ) {
                colorTemp.style.fill = tempHotExt;
                colorTemp.style.stroke = tempHotExt;
              } else if ( temperatura < 39 && temperatura >= 30 ) {
                colorTemp.style.fill = tempMhotExt;
                colorTemp.style.stroke = tempMhotExt;
              } else if ( temperatura < 30 && temperatura > 20 ) {
                colorTemp.style.fill = tempOkExt;
                colorTemp.style.stroke = tempOkExt;
              } else {
                colorTemp.style.fill = tempoColdExt;
                colorTemp.style.stroke = tempoColdExt;
              }
            
              const tooltipConfigs = [
                ...elementsConfigTyH.map(({ idSuffix, metric }) => 
                createTooltipConfig(`#${nombre}_${idSuffix}`, "chart", { nombre, medicion: metric, tabla: "mediciones_clima_24hs" }, TOOLTIP_CHART_CONFIG))
            ];

            tooltipConfigs.forEach(({ selector, tooltipType, payload, config }) => {
                const element = svg.querySelector(selector);
                if (element) {
                    //console.log(element);
                    element.addEventListener("mouseover", (e) => displayTooltip(e, tooltipType, payload, config));
                    element.addEventListener("mouseleave", () => hideTooltip(tooltipType));
                }
            });/**/


        } else {
            console.warn('error en clima exterior');
        }
    } catch {
        console.warn('No hay conexion con el servidor');
    }
}

onMounted(() => {
    dataAndAccion();
    intervalId = setInterval(dataAndAccion, 10000); // Llama a fetchData cada 10 segundos
});

// Limpia el intervalo cuando el componente se desmonte
onUnmounted(() => {
  clearInterval(intervalId);
});

</script>

<style scoped></style>
